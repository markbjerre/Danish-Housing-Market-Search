<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copenhagen Housing Search - 84k+ Villas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .search-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
        }

        .text-search-container {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .text-search-container input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.05em;
            border: 2px solid #667eea;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .text-search-container input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
        }

        .text-search-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
            display: block;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
            width: 100%;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9em;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Price Range Slider */
        .price-slider-container {
            padding: 10px 5px;
        }

        .price-slider-wrapper {
            position: relative;
            height: 40px;
            margin-bottom: 10px;
        }

        .price-slider {
            position: relative;
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 17px;
        }

        .price-slider-track {
            position: absolute;
            height: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            top: 0;
        }

        .price-slider input[type="range"] {
            position: absolute;
            width: 100%;
            height: 6px;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
            top: 17px;
        }

        .price-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            pointer-events: auto;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .price-slider input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            pointer-events: auto;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .price-values {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
        }

        .price-values span {
            font-weight: 600;
        }

        .search-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .score-calculator-section {
            margin-top: 20px;
            border-top: 2px solid #f0f0f0;
            padding-top: 20px;
        }

        .score-calculator-toggle {
            width: 100%;
            padding: 12px 15px;
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            color: #667eea;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .score-calculator-toggle:hover {
            background: #e8eeff;
            border-color: #764ba2;
        }

        .score-calculator-panel {
            background: #fafbfc;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .score-weights {
            margin: 15px 0;
        }

        .score-weights input[type="range"] {
            width: 100%;
        }

        .results-info {
            background: white;
            border-radius: 10px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            justify-items: center;
        }

        .property-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            width: 100%;
            max-width: 380px;
        }

        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .property-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .property-address {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .property-location {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .property-critical {
            padding: 20px;
        }

        .critical-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }

        .info-value.price {
            color: #667eea;
        }

        .property-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .tag {
            background: #f0f0f0;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #555;
        }

        .tag.energy {
            background: #4caf50;
            color: white;
            font-weight: 600;
        }

        .tag.on-market {
            background: #ff5722;
            color: white;
            font-weight: 600;
        }

        .expand-button {
            width: 100%;
            background: #f8f9fa;
            border: none;
            padding: 12px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            transition: background 0.3s;
            border-top: 1px solid #e0e0e0;
        }

        .expand-button:hover {
            background: #e9ecef;
        }

        /* Modal Overlay for Property Details */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            margin: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            flex: 1;
        }

        .detail-section {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .detail-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .detail-section h3::before {
            content: '‚ñº';
            margin-right: 10px;
            transition: transform 0.3s;
            display: inline-block;
        }

        .detail-section h3.collapsed::before {
            transform: rotate(-90deg);
        }

        .detail-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .detail-content.hidden {
            display: none;
        }

        .detail-item {
            padding: 8px 0;
        }

        .detail-item strong {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 3px;
        }

        .map-container {
            height: 300px;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-button {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .page-button:hover {
            background: #667eea;
            color: white;
        }

        .page-button.active {
            background: #667eea;
            color: white;
        }

        .page-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .no-results {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .no-results h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        @media (max-width: 1024px) {
            .filters {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .search-panel {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 0 5px;
            }

            .results-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.6em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1em;
            }

            .filters {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 15px;
            }

            .search-panel {
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 10px;
            }

            .search-button {
                padding: 12px 30px;
                font-size: 1em;
            }

            .filter-group label {
                font-size: 0.85em;
                margin-bottom: 6px;
            }

            .filter-group input,
            .filter-group select {
                padding: 8px;
                font-size: 0.95em;
            }

            .range-inputs {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .modal-content {
                margin: 20px auto;
                width: 95%;
                max-width: 100%;
            }

            .critical-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .property-card {
                border-radius: 12px;
            }

            .property-address {
                font-size: 1.1em;
            }

            .property-header {
                padding: 15px;
            }

            .property-critical {
                padding: 15px;
            }

            .results-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                padding: 12px 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 0;
            }

            .header h1 {
                font-size: 1.4em;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 0.9em;
                margin-bottom: 15px;
            }

            .search-panel {
                padding: 12px;
                margin-bottom: 15px;
            }

            .filters {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 12px;
            }

            .filter-group label {
                font-size: 0.8em;
                margin-bottom: 5px;
            }

            .filter-group input,
            .filter-group select {
                padding: 7px;
                font-size: 0.9em;
            }

            .range-inputs {
                gap: 6px;
            }

            .range-inputs input {
                font-size: 0.85em;
                padding: 6px;
            }

            .search-button {
                padding: 10px 20px;
                font-size: 0.95em;
                font-weight: 500;
            }

            .results-grid {
                gap: 12px;
            }

            .property-card {
                border-radius: 10px;
            }

            .property-header {
                padding: 12px;
            }

            .property-address {
                font-size: 1em;
                margin-bottom: 3px;
            }

            .property-location {
                font-size: 0.85em;
            }

            .property-critical {
                padding: 12px;
            }

            .critical-info {
                gap: 8px;
            }

            .info-item {
                margin-bottom: 8px;
            }

            .info-label {
                font-size: 0.75em;
            }

            .info-value {
                font-size: 0.9em;
            }

            .price-slider-container {
                padding: 8px 3px;
            }

            .price-values {
                font-size: 0.75em;
                margin-top: 3px;
            }

            .results-info {
                flex-direction: column;
                gap: 8px;
                padding: 10px 12px;
                font-size: 0.85em;
            }

            .modal-content {
                width: 98%;
                margin: 15px auto;
            }

            .modal-header {
                padding: 12px 15px;
            }

            .modal-body {
                padding: 12px;
                max-height: calc(100vh - 150px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Copenhagen Housing Search</h1>
            <p>Search through 84,469+ villas in the Copenhagen area</p>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/" style="color: white; text-decoration: none; margin: 0 15px; font-size: 1.1em; font-weight: 600; padding: 8px 20px; border-radius: 25px; background: rgba(255,255,255,0.3);">üè† Property Search</a>
            <a href="/score-calculator" style="color: white; text-decoration: none; margin: 0 15px; font-size: 1.1em; font-weight: 600; padding: 8px 20px; border-radius: 25px; background: rgba(255,255,255,0.2); transition: background 0.3s;">üéØ Score Calculator</a>
        </div>

        <div class="search-panel">
            <div class="text-search-container">
                <label class="text-search-label" for="text_search">üîç Search Address, City, or Municipality</label>
                <input type="text" id="text_search" placeholder="e.g., 'Strandvejen, Hellerup' or 'K√∏benhavn' or postal code..." 
                       onkeyup="handleTextSearchInput(event)">
            </div>
            <div class="filters">
                <div class="filter-group">
                    <label for="municipality">üèõÔ∏è Municipality</label>
                    <select id="municipality">
                        <option value="all">All Municipalities</option>
                        {% for muni in municipalities %}
                        <option value="{{ muni }}">{{ muni }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="max_distance">üìç Distance to Copenhagen</label>
                    <select id="max_distance">
                        <option value="">Any distance</option>
                        <option value="10">Within 10 km</option>
                        <option value="20">Within 20 km</option>
                        <option value="30">Within 30 km</option>
                        <option value="40">Within 40 km</option>
                        <option value="50">Within 50 km</option>
                        <option value="60">Within 60 km</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>üìê Living Area (m¬≤)</label>
                    <div class="range-inputs">
                        <input type="number" id="min_area" placeholder="Min" step="10">
                        <input type="number" id="max_area" placeholder="Max" step="10">
                    </div>
                </div>

                <div class="filter-group">
                    <label>üí∞ Price Range (DKK)</label>
                    <div class="price-slider-container">
                        <div class="price-slider-wrapper">
                            <div class="price-slider">
                                <div class="price-slider-track" id="price-track"></div>
                            </div>
                            <input type="range" id="min_price_slider" min="0" max="20000000" value="0" step="100000">
                            <input type="range" id="max_price_slider" min="0" max="20000000" value="20000000" step="100000">
                        </div>
                        <div class="price-values">
                            <span id="min_price_display">0 kr</span>
                            <span id="max_price_display">20M kr</span>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>üõèÔ∏è Number of Rooms</label>
                    <div class="range-inputs">
                        <input type="number" id="min_rooms" placeholder="Min" step="1">
                        <input type="number" id="max_rooms" placeholder="Max" step="1">
                    </div>
                </div>

                <div class="filter-group">
                    <label>üìÖ Year Built</label>
                    <div class="range-inputs">
                        <input type="number" id="min_year" placeholder="Min" step="10">
                        <input type="number" id="max_year" placeholder="Max" step="10">
                    </div>
                </div>

                <div class="filter-group">
                    <label for="on_market">üè∑Ô∏è Market Status</label>
                    <select id="on_market">
                        <option value="">All Properties</option>
                        <option value="true">On Market Only</option>
                        <option value="false">Sold Properties</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="realtor">üè¢ Realtor</label>
                    <input type="text" id="realtor" placeholder="Realtor name">
                </div>

                <div class="filter-group">
                    <label>‚è∞ Days on Market</label>
                    <div class="range-inputs">
                        <input type="number" id="min_days" placeholder="Min" step="1">
                        <input type="number" id="max_days" placeholder="Max" step="1">
                    </div>
                </div>
            </div>

            <button class="search-button" onclick="searchProperties()">üîç Search Properties</button>

            <!-- Score Calculator Section -->
            <div class="score-calculator-section">
                <button class="score-calculator-toggle" onclick="toggleScoreCalculator()">üéØ Score Calculator - Click to Expand</button>
                <div id="score-calculator-panel" class="score-calculator-panel" style="display: none;">
                    <h3 style="margin-top: 0;">Property Scoring</h3>
                    <p style="color: #666; font-size: 0.9em; margin: 10px 0;">Set weights for different property factors to calculate a score for each property.</p>
                    
                    <div class="score-weights" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0;">
                        <div>
                            <label>Price per m¬≤ Weight</label>
                            <input type="range" id="weight-price" min="0" max="10" value="5" style="width: 100%;">
                            <span id="weight-price-val">5</span> / 10
                        </div>
                        <div>
                            <label>Living Area Weight</label>
                            <input type="range" id="weight-area" min="0" max="10" value="5" style="width: 100%;">
                            <span id="weight-area-val">5</span> / 10
                        </div>
                        <div>
                            <label>Distance to Center Weight</label>
                            <input type="range" id="weight-distance" min="0" max="10" value="3" style="width: 100%;">
                            <span id="weight-distance-val">3</span> / 10
                        </div>
                        <div>
                            <label>Energy Label Weight</label>
                            <input type="range" id="weight-energy" min="0" max="10" value="2" style="width: 100%;">
                            <span id="weight-energy-val">2</span> / 10
                        </div>
                    </div>
                    
                    <button class="search-button" onclick="calculateScoresInline()" style="margin-top: 10px;">üìä Score Current Results</button>
                </div>
            </div>
        

        <div id="results-info" class="results-info" style="display: none;">
            <div>
                <strong>Found <span id="total-count">0</span> properties</strong>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div>
                    <label for="sort_by" style="margin-right: 8px; font-weight: 500;">üìä Sort by:</label>
                    <select id="sort_by" onchange="searchProperties()" style="padding: 8px 12px; border-radius: 8px; border: 2px solid #667eea; background: white; cursor: pointer; font-size: 0.95em;">
                        <option value="price_desc">Price (High to Low)</option>
                        <option value="price_asc">Price (Low to High)</option>
                        <option value="size_desc">Size (Largest First)</option>
                        <option value="year_desc">Newest First</option>
                        <option value="price_per_sqm_asc">Price per m¬≤ (Low to High)</option>
                    </select>
                </div>
                <div>
                    Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                </div>
            </div>
        </div>

        <div id="results" class="results-grid"></div>

        <div id="pagination" class="pagination"></div>
    </div>

    <!-- Modal for property details -->
    <div id="property-modal" class="modal-overlay" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <button class="modal-close" onclick="closePropertyModal()">√ó</button>
                <div id="modal-header-content"></div>
            </div>
            <div class="modal-body" id="modal-body-content">
                <div class="loading" style="padding: 40px;">Loading property details...</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentPage = 1;
        let propertyMaps = {};
        const COPENHAGEN_LAT = 55.6761;
        const COPENHAGEN_LON = 12.5683;

        // Initialize price range slider
        const minPriceSlider = document.getElementById('min_price_slider');
        const maxPriceSlider = document.getElementById('max_price_slider');
        const minPriceDisplay = document.getElementById('min_price_display');
        const maxPriceDisplay = document.getElementById('max_price_display');
        const priceTrack = document.getElementById('price-track');

        function updatePriceSlider() {
            const minVal = parseInt(minPriceSlider.value);
            const maxVal = parseInt(maxPriceSlider.value);

            if (minVal > maxVal - 100000) {
                minPriceSlider.value = maxVal - 100000;
            }
            if (maxVal < minVal + 100000) {
                maxPriceSlider.value = minVal + 100000;
            }

            const minPercent = (minPriceSlider.value / minPriceSlider.max) * 100;
            const maxPercent = (maxPriceSlider.value / maxPriceSlider.max) * 100;
            
            priceTrack.style.left = minPercent + '%';
            priceTrack.style.width = (maxPercent - minPercent) + '%';

            minPriceDisplay.textContent = formatPrice(minPriceSlider.value);
            maxPriceDisplay.textContent = formatPrice(maxPriceSlider.value);
        }

        function formatPrice(value) {
            const val = parseInt(value);
            if (val === 0) return '0 kr';
            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M kr';
            if (val >= 1000) return (val / 1000).toFixed(0) + 'k kr';
            return val + ' kr';
        }

        minPriceSlider.addEventListener('input', updatePriceSlider);
        maxPriceSlider.addEventListener('input', updatePriceSlider);
        updatePriceSlider();

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Text search debounce timer
        let textSearchTimeout;

        // Handle text search input with debouncing
        function handleTextSearchInput(event) {
            clearTimeout(textSearchTimeout);
            const query = document.getElementById('text_search').value.trim();
            
            // Perform search with slight delay for responsiveness
            textSearchTimeout = setTimeout(() => {
                if (query.length >= 2) {
                    performTextSearch(query);
                } else if (query.length === 0) {
                    // If cleared, go back to regular search
                    searchProperties(1);
                }
            }, 300); // Debounce by 300ms
        }

        // Perform text-based search
        async function performTextSearch(query, page = 1) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîç Searching for "' + query + '"...</div>';

            try {
                const params = new URLSearchParams({
                    q: query,
                    page: page
                });

                const response = await fetch(`/api/text-search?${params}`);
                const data = await response.json();

                if (!data.success) {
                    resultsDiv.innerHTML = `<div class="no-results"><h2>Error</h2><p>${data.error}</p></div>`;
                    return;
                }

                // Update results header
                const resultsInfo = document.getElementById('results-info');
                document.getElementById('total-count').textContent = data.total.toLocaleString();
                document.getElementById('current-page').textContent = data.page;
                document.getElementById('total-pages').textContent = data.total_pages;
                resultsInfo.style.display = 'flex';

                // Display results
                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results"><h2>No properties found</h2><p>Try a different search term</p></div>';
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                resultsDiv.innerHTML = data.results.map(prop => createPropertyCard(prop)).join('');

                // Create pagination for text search
                createTextSearchPagination(data, query);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="no-results"><h2>Error searching</h2><p>${error.message}</p></div>`;
            }
        }

        // Create pagination buttons for text search
        function createTextSearchPagination(data, query) {
            const paginationDiv = document.getElementById('pagination');
            if (data.total_pages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }

            let html = '';
            const maxButtons = 5;
            const startPage = Math.max(1, data.page - Math.floor(maxButtons / 2));
            const endPage = Math.min(data.total_pages, startPage + maxButtons - 1);

            if (data.page > 1) {
                html += `<button class="page-button" onclick="performTextSearch('${query}', ${data.page - 1})">‚Üê Previous</button>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-button ${i === data.page ? 'active' : ''}" onclick="performTextSearch('${query}', ${i})">${i}</button>`;
            }

            if (data.page < data.total_pages) {
                html += `<button class="page-button" onclick="performTextSearch('${query}', ${data.page + 1})">Next ‚Üí</button>`;
            }

            paginationDiv.innerHTML = html;
        }

        // Search properties
        async function searchProperties(page = 1) {
            currentPage = page;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîÑ Searching properties...</div>';

            // Build query parameters
            const minPrice = parseInt(minPriceSlider.value);
            const maxPrice = parseInt(maxPriceSlider.value);
            
            const params = new URLSearchParams({
                page: page,
                municipality: document.getElementById('municipality').value,
                min_price: minPrice > 0 ? minPrice : '',
                max_price: maxPrice < 20000000 ? maxPrice : '',
                min_area: document.getElementById('min_area').value || '',
                max_area: document.getElementById('max_area').value || '',
                min_rooms: document.getElementById('min_rooms').value || '',
                max_rooms: document.getElementById('max_rooms').value || '',
                min_year: document.getElementById('min_year').value || '',
                max_year: document.getElementById('max_year').value || '',
                on_market: document.getElementById('on_market').value || '',
                realtor: document.getElementById('realtor').value || '',
                min_days_on_market: document.getElementById('min_days').value || '',
                max_days_on_market: document.getElementById('max_days').value || '',
                sort_by: document.getElementById('sort_by')?.value || 'price_desc',
            });

            try {
                const response = await fetch(`/api/search?${params}`);
                const data = await response.json();

                // Apply distance filter on client side
                const maxDistance = document.getElementById('max_distance').value;
                if (maxDistance) {
                    const maxDistKm = parseFloat(maxDistance);
                    data.results = data.results.filter(prop => {
                        if (!prop.latitude || !prop.longitude) return false;
                        const distance = calculateDistance(
                            COPENHAGEN_LAT, COPENHAGEN_LON,
                            prop.latitude, prop.longitude
                        );
                        return distance <= maxDistKm;
                    });
                    data.total = data.results.length;
                }

                displayResults(data);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="no-results"><h2>Error loading properties</h2><p>${error.message}</p></div>`;
            }
        }

        // Display results
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const resultsInfo = document.getElementById('results-info');
            const paginationDiv = document.getElementById('pagination');

            if (data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results"><h2>No properties found</h2><p>Try adjusting your search filters</p></div>';
                resultsInfo.style.display = 'none';
                paginationDiv.innerHTML = '';
                return;
            }

            // Update results info
            document.getElementById('total-count').textContent = data.total.toLocaleString();
            document.getElementById('current-page').textContent = data.page;
            document.getElementById('total-pages').textContent = data.total_pages;
            resultsInfo.style.display = 'flex';

            // Display property cards
            resultsDiv.innerHTML = data.results.map(prop => createPropertyCard(prop)).join('');

            // Create pagination
            createPagination(data);
        }

        // Create property card HTML
        function createPropertyCard(prop) {
            const price = prop.price ? `${(prop.price / 1000000).toFixed(1)}M DKK` : 'N/A';
            const area = prop.living_area ? `${prop.living_area} m¬≤` : 'N/A';
            const rooms = prop.rooms || 'N/A';
            const year = prop.year_built || 'N/A';
            const energy = prop.energy_label ? prop.energy_label.toUpperCase() : '';
            const onMarket = prop.on_market ? '<span class="tag on-market">üî• On Market</span>' : '';
            
            // Price per m¬≤
            const pricePerSqm = prop.price_per_sqm ? `${prop.price_per_sqm.toLocaleString()} kr/m¬≤` : 'N/A';
            
            // Area average comparison
            let areaAvgInfo = '';
            if (prop.price_per_sqm && prop.area_avg_price_per_sqm) {
                const diff = ((prop.price_per_sqm - prop.area_avg_price_per_sqm) / prop.area_avg_price_per_sqm * 100).toFixed(1);
                const color = diff < 0 ? '#4caf50' : '#ff5722';
                areaAvgInfo = `<div class="info-item">
                    <span class="info-label">üìä vs Area Avg</span>
                    <span class="info-value" style="color: ${color}; font-size: 0.9em;">${diff > 0 ? '+' : ''}${diff}%</span>
                </div>`;
            }
            
            // Calculate distance to Copenhagen
            let distanceTag = '';
            if (prop.latitude && prop.longitude) {
                const distance = calculateDistance(
                    COPENHAGEN_LAT, COPENHAGEN_LON,
                    prop.latitude, prop.longitude
                );
                distanceTag = `<span class="tag">üìç ${distance.toFixed(1)} km</span>`;
            }
            
            // Days on market
            let daysOnMarketTag = '';
            if (prop.days_on_market) {
                daysOnMarketTag = `<span class="tag">‚è∞ ${prop.days_on_market} days on market</span>`;
            }
            
            // Boligsiden link
            const boligsidenUrl = prop.slug ? `https://www.boligsiden.dk/adresse/${prop.slug}` : null;

            return `
                <div class="property-card" onclick="openPropertyModal('${prop.id}')" 
                     data-price="${prop.price || 0}" 
                     data-area="${prop.living_area || 0}" 
                     data-lat="${prop.latitude || 0}" 
                     data-lon="${prop.longitude || 0}" 
                     data-energy="${prop.energy_label || 'N/A'}">
                    <div class="property-header">
                        <div class="property-address">${prop.address}</div>
                        <div class="property-location">${prop.zip_code} ${prop.city} ‚Ä¢ ${prop.municipality}</div>
                    </div>
                    
                    <div class="property-critical">
                        <div class="critical-info">
                            <div class="info-item">
                                <span class="info-label">üí∞ Price</span>
                                <span class="info-value price">${price}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üìê Living Area</span>
                                <span class="info-value">${area}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üíµ Price/m¬≤</span>
                                <span class="info-value">${pricePerSqm}</span>
                            </div>
                            ${areaAvgInfo}
                            <div class="info-item">
                                <span class="info-label">üõèÔ∏è Rooms</span>
                                <span class="info-value">${rooms}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üìÖ Year Built</span>
                                <span class="info-value">${year}</span>
                            </div>
                        </div>
                        
                        <div class="property-tags">
                            ${energy ? `<span class="tag energy">‚ö° ${energy}</span>` : ''}
                            ${onMarket}
                            <span class="tag">üèòÔ∏è Villa</span>
                            ${distanceTag}
                            ${daysOnMarketTag}
                        </div>
                        
                        ${boligsidenUrl ? `
                        <a href="${boligsidenUrl}" target="_blank" onclick="event.stopPropagation()" 
                           style="display: block; margin-top: 15px; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                  color: white; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600;">
                            üîó Go to Boligportalen
                        </a>
                        ` : ''}
                    </div>
                    
                    <button class="expand-button" onclick="event.stopPropagation(); openPropertyModal('${prop.id}')">
                        üëÅÔ∏è View Full Details
                    </button>
                </div>
            `;
        }

        // Open property modal
        async function openPropertyModal(propertyId) {
            const modal = document.getElementById('property-modal');
            const headerContent = document.getElementById('modal-header-content');
            const bodyContent = document.getElementById('modal-body-content');
            
            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Set loading state
            bodyContent.innerHTML = '<div class="loading" style="padding: 40px;">Loading property details...</div>';
            
            try {
                console.log('üì° Fetching property details for ID:', propertyId);
                const response = await fetch(`/api/property/${propertyId}`);
                const data = await response.json();
                
                console.log('‚úÖ Response received:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load property');
                }
                
                const property = data.property;
                console.log('üè† Property data:', property);
                
                // Set header
                headerContent.innerHTML = `
                    <div class="property-address" style="font-size: 1.8em;">${property.address}</div>
                    <div class="property-location" style="font-size: 1.1em; opacity: 0.9;">
                        ${property.zip_code} ${property.city}${property.municipality ? ' ‚Ä¢ ' + property.municipality : ''}
                    </div>
                `;
                
                // Set body with detailed view
                const detailHTML = createDetailedView(property);
                console.log('üìù Generated HTML length:', detailHTML.length);
                bodyContent.innerHTML = detailHTML;
                console.log('‚ú® HTML inserted into modal body');
                
                // Initialize map if coordinates exist
                if (property.latitude && property.longitude) {
                    setTimeout(() => initMap(propertyId, property.latitude, property.longitude), 100);
                }
            } catch (error) {
                console.error('‚ùå Error loading property:', error);
                bodyContent.innerHTML = `<div style="padding: 40px; color: red; text-align: center;">
                    <h2>Error loading property details</h2>
                    <p>${error.message}</p>
                </div>`;
            }
        }

        // Close property modal
        function closePropertyModal() {
            const modal = document.getElementById('property-modal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking backdrop
        function closeModalOnBackdrop(event) {
            if (event.target.id === 'property-modal') {
                closePropertyModal();
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closePropertyModal();
            }
        });

        // Create detailed view HTML
        function createDetailedView(data) {
            let html = '';
            
            // Price section at top
            html += `
                <div class="detail-section">
                    <h3 onclick="toggleSection(this)">üí∞ Price & Area</h3>
                    <div class="detail-content">
                        ${data.price ? `<div class="detail-item"><strong>Price</strong><div>${(data.price).toLocaleString()} DKK</div></div>` : '<div class="detail-item"><strong>Price</strong><div>Not available</div></div>'}
                        ${data.price_per_sqm ? `<div class="detail-item"><strong>Price per m¬≤</strong><div>${data.price_per_sqm.toLocaleString()} DKK/m¬≤</div></div>` : ''}
                        ${data.living_area ? `<div class="detail-item"><strong>Living Area</strong><div>${data.living_area.toLocaleString()} m¬≤</div></div>` : ''}
                        ${data.rooms ? `<div class="detail-item"><strong>Rooms</strong><div>${data.rooms}</div></div>` : ''}
                        ${data.year_built ? `<div class="detail-item"><strong>Year Built</strong><div>${data.year_built}</div></div>` : ''}
                        ${data.energy_label ? `<div class="detail-item"><strong>Energy Label</strong><div>${data.energy_label}</div></div>` : ''}
                        ${data.days_on_market ? `<div class="detail-item"><strong>Days on Market</strong><div>${data.days_on_market}</div></div>` : ''}
                    </div>
                </div>
            `;

            // Building Details Section
            if (data.main_building) {
                const building = data.main_building;
                html += `
                    <div class="detail-section">
                        <h3 onclick="toggleSection(this)">üèóÔ∏è Building Details</h3>
                        <div class="detail-content">
                            ${building.building_name ? `<div class="detail-item"><strong>Type</strong><div>${building.building_name}</div></div>` : ''}
                            ${building.year_built ? `<div class="detail-item"><strong>Built</strong><div>${building.year_built}</div></div>` : ''}
                            ${building.year_renovated ? `<div class="detail-item"><strong>Renovated</strong><div>${building.year_renovated}</div></div>` : ''}
                            ${building.number_of_floors ? `<div class="detail-item"><strong>Floors</strong><div>${building.number_of_floors}</div></div>` : ''}
                            ${building.number_of_rooms ? `<div class="detail-item"><strong>Rooms</strong><div>${building.number_of_rooms}</div></div>` : ''}
                            ${building.number_of_bathrooms ? `<div class="detail-item"><strong>Bathrooms</strong><div>${building.number_of_bathrooms}</div></div>` : ''}
                            ${building.number_of_toilets ? `<div class="detail-item"><strong>Toilets</strong><div>${building.number_of_toilets}</div></div>` : ''}
                            ${building.housing_area ? `<div class="detail-item"><strong>Housing Area</strong><div>${building.housing_area} m¬≤</div></div>` : ''}
                            ${building.basement_area ? `<div class="detail-item"><strong>Basement</strong><div>${building.basement_area} m¬≤</div></div>` : ''}
                            ${building.total_area ? `<div class="detail-item"><strong>Total Area</strong><div>${building.total_area} m¬≤</div></div>` : ''}
                            ${building.external_wall_material ? `<div class="detail-item"><strong>Wall Material</strong><div>${building.external_wall_material}</div></div>` : ''}
                            ${building.roofing_material ? `<div class="detail-item"><strong>Roof Material</strong><div>${building.roofing_material}</div></div>` : ''}
                            ${building.heating_installation ? `<div class="detail-item"><strong>Heating</strong><div>${building.heating_installation}</div></div>` : ''}
                            ${building.kitchen_condition ? `<div class="detail-item"><strong>Kitchen</strong><div>${building.kitchen_condition}</div></div>` : ''}
                            ${building.bathroom_condition ? `<div class="detail-item"><strong>Bathroom</strong><div>${building.bathroom_condition}</div></div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="detail-section">
                        <h3>‚ÑπÔ∏è Building Details</h3>
                        <div class="detail-content">
                            <div class="detail-item"><strong>Info</strong><div>Building details not available in database</div></div>
                        </div>
                    </div>
                `;
            }

            // Case/Listing Information
            if (data.case_info) {
                const caseInfo = data.case_info;
                html += `
                    <div class="detail-section">
                        <h3 onclick="toggleSection(this)">üìã Listing Information</h3>
                        <div class="detail-content">
                            ${caseInfo.listing_date ? `<div class="detail-item"><strong>Listed Date</strong><div>${caseInfo.listing_date}</div></div>` : ''}
                            ${caseInfo.current_price ? `<div class="detail-item"><strong>Current Price</strong><div>${(caseInfo.current_price).toLocaleString()} DKK</div></div>` : ''}
                            ${caseInfo.previous_price ? `<div class="detail-item"><strong>Previous Price</strong><div>${(caseInfo.previous_price).toLocaleString()} DKK</div></div>` : ''}
                            ${caseInfo.status ? `<div class="detail-item"><strong>Status</strong><div>${caseInfo.status}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Registration History
            if (data.registrations && data.registrations.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3 onclick="toggleSection(this)">üìä Transaction History</h3>
                        <div class="detail-content">
                            ${data.registrations.map(reg => `
                                <div class="detail-item">
                                    <strong>${reg.date || 'N/A'}</strong>
                                    <div>${reg.amount ? (reg.amount / 1000000).toFixed(2) + 'M DKK' : 'N/A'}</div>
                                    <div style="font-size: 0.85em; color: #666;">${reg.type || 'Unknown'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Municipality Info
            if (data.municipality_info) {
                const muni = data.municipality_info;
                html += `
                    <div class="detail-section">
                        <h3 onclick="toggleSection(this)">üèõÔ∏è Municipality Info</h3>
                        <div class="detail-content">
                            ${muni.name ? `<div class="detail-item"><strong>Municipality</strong><div>${muni.name}</div></div>` : ''}
                            ${muni.population ? `<div class="detail-item"><strong>Population</strong><div>${muni.population.toLocaleString()}</div></div>` : ''}
                            ${muni.council_tax ? `<div class="detail-item"><strong>Council Tax</strong><div>${muni.council_tax}%</div></div>` : ''}
                            ${muni.church_tax ? `<div class="detail-item"><strong>Church Tax</strong><div>${muni.church_tax}%</div></div>` : ''}
                            ${muni.number_of_schools ? `<div class="detail-item"><strong>Schools</strong><div>${muni.number_of_schools}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Map Section
            if (data.latitude && data.longitude) {
                html += `
                    <div class="detail-section">
                        <h3 onclick="toggleSection(this)">üó∫Ô∏è Location</h3>
                        <div class="detail-content" style="grid-template-columns: 1fr;">
                            <div id="map-${data.id}" class="map-container"></div>
                        </div>
                    </div>
                `;
            }

            // Technical Data (collapsed by default)
            html += `
                <div class="detail-section">
                    <h3 onclick="toggleSection(this)" class="collapsed">üîß Technical Data</h3>
                    <div class="detail-content hidden">
                        ${data.id ? `<div class="detail-item"><strong>Property ID</strong><div style="font-size: 0.8em; word-break: break-all;">${data.id}</div></div>` : ''}
                        ${data.address ? `<div class="detail-item"><strong>Address</strong><div>${data.address}</div></div>` : ''}
                        ${data.zip_code ? `<div class="detail-item"><strong>Zip Code</strong><div>${data.zip_code}</div></div>` : ''}
                    </div>
                </div>
            `;

            return html;
        }

        // Toggle detail section
        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('hidden');
        }

        // Initialize map
        function initMap(propertyId, lat, lon) {
            const mapId = `map-${propertyId}`;
            if (propertyMaps[mapId]) return; // Already initialized

            const map = L.map(mapId).setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            L.marker([lat, lon]).addTo(map);

            propertyMaps[mapId] = map;
        }

        // Create pagination
        function createPagination(data) {
            const paginationDiv = document.getElementById('pagination');
            let html = '';

            // Previous button
            html += `<button class="page-button" onclick="searchProperties(${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}>‚Üê Previous</button>`;

            // Page numbers (show 5 pages max)
            const startPage = Math.max(1, data.page - 2);
            const endPage = Math.min(data.total_pages, data.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-button ${i === data.page ? 'active' : ''}" onclick="searchProperties(${i})">${i}</button>`;
            }

            // Next button
            html += `<button class="page-button" onclick="searchProperties(${data.page + 1})" ${data.page === data.total_pages ? 'disabled' : ''}>Next ‚Üí</button>`;

            paginationDiv.innerHTML = html;
        }

        // Load initial results on page load
        window.onload = () => {
            // Set default filters
            document.getElementById('on_market').value = 'true';  // Show only properties on market
            searchProperties(1);
            
            // Setup weight range sliders
            setupWeightSliders();
        };

        // Setup weight range sliders
        function setupWeightSliders() {
            const weights = ['weight-price', 'weight-area', 'weight-distance', 'weight-energy'];
            weights.forEach(weight => {
                const slider = document.getElementById(weight);
                if (slider) {
                    slider.addEventListener('input', (e) => {
                        document.getElementById(weight + '-val').textContent = e.target.value;
                    });
                }
            });
        }

        // Toggle score calculator panel
        function toggleScoreCalculator() {
            const panel = document.getElementById('score-calculator-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // Calculate scores for current results
        function calculateScoresInline() {
            const resultsDiv = document.getElementById('results');
            const cards = resultsDiv.querySelectorAll('.property-card');
            
            if (cards.length === 0) {
                alert('Please search for properties first');
                return;
            }

            // Get weights
            const weights = {
                price: parseFloat(document.getElementById('weight-price').value) || 5,
                area: parseFloat(document.getElementById('weight-area').value) || 5,
                distance: parseFloat(document.getElementById('weight-distance').value) || 3,
                energy: parseFloat(document.getElementById('weight-energy').value) || 2,
            };

            // Calculate scores for displayed properties
            const scoredProperties = [];
            cards.forEach(card => {
                const priceText = card.querySelector('[data-price]')?.getAttribute('data-price');
                const areaText = card.querySelector('[data-area]')?.getAttribute('data-area');
                const latText = card.querySelector('[data-lat]')?.getAttribute('data-lat');
                const lonText = card.querySelector('[data-lon]')?.getAttribute('data-lon');
                const energyText = card.querySelector('[data-energy]')?.getAttribute('data-energy');

                const price = parseFloat(priceText) || 0;
                const area = parseFloat(areaText) || 0;
                const lat = parseFloat(latText) || 0;
                const lon = parseFloat(lonText) || 0;
                const energy = energyText || 'N/A';

                let score = 0;
                let scoreBreakdown = [];

                // Price per m¬≤ (lower is better, normalized 0-10)
                if (price > 0 && area > 0) {
                    const pricePerSqm = price / area;
                    const priceScore = Math.max(0, 10 - (pricePerSqm / 10000));
                    score += priceScore * weights.price;
                    scoreBreakdown.push(`Price: ${priceScore.toFixed(1)}`);
                }

                // Living area (larger is better, normalized 0-10)
                if (area > 0) {
                    const areaScore = Math.min(10, area / 30);
                    score += areaScore * weights.area;
                    scoreBreakdown.push(`Area: ${areaScore.toFixed(1)}`);
                }

                // Distance (closer is better, from Copenhagen center)
                if (lat > 0 && lon > 0) {
                    const COPENHAGEN_LAT = 55.6761;
                    const COPENHAGEN_LON = 12.5683;
                    const distance = calculateHaversineDistance(COPENHAGEN_LAT, COPENHAGEN_LON, lat, lon);
                    const distanceScore = Math.max(0, 10 - (distance / 6));
                    score += distanceScore * weights.distance;
                    scoreBreakdown.push(`Distance: ${distanceScore.toFixed(1)}`);
                }

                // Energy label
                if (energy && energy !== 'N/A') {
                    const energyScores = { a: 10, b: 8, c: 6, d: 4, e: 2, f: 1, g: 0 };
                    const energyScore = energyScores[energy.toLowerCase()] || 0;
                    score += energyScore * weights.energy;
                    scoreBreakdown.push(`Energy: ${energyScore.toFixed(1)}`);
                }

                // Normalize score to 0-100
                const maxPossibleScore = (weights.price + weights.area + weights.distance + weights.energy) * 10;
                const normalizedScore = maxPossibleScore > 0 ? (score / maxPossibleScore) * 100 : 0;

                scoredProperties.push({
                    card: card,
                    score: normalizedScore,
                    breakdown: scoreBreakdown.join(', ')
                });
            });

            // Sort by score
            scoredProperties.sort((a, b) => b.score - a.score);

            // Update card display with scores
            scoredProperties.forEach((item, index) => {
                const scoreLabel = item.card.querySelector('.score-label') || createScoreLabel();
                scoreLabel.innerHTML = `<strong>Score: ${item.score.toFixed(1)}/100</strong><br><small>${item.breakdown}</small>`;
                
                // Insert or update score label
                if (!item.card.querySelector('.score-label')) {
                    item.card.insertBefore(scoreLabel, item.card.firstChild);
                }
            });

            // Show success message
            alert(`‚úÖ Scored ${scoredProperties.length} properties!`);
        }

        // Create score label element
        function createScoreLabel() {
            const label = document.createElement('div');
            label.className = 'score-label';
            label.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin-bottom: 10px; font-weight: 600; color: #856404; font-size: 0.9em;';
            return label;
        }

        // Calculate Haversine distance between two coordinates
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>
